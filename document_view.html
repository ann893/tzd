<!-- templates/document_view.html -->
{% extends "base.html" %}

{% block title %}–î–æ–∫—É–º–µ–Ω—Ç: {{ document.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>{{ document.title }}</h4>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>–¢–∏–ø:</strong>
                            {% if document.type == 'service_note' %}–°–ª—É–∂–µ–±–Ω–∞—è –∑–∞–ø–∏—Å–∫–∞
                            {% elif document.type == 'order' %}–ü—Ä–∏–∫–∞–∑
                            {% elif document.type == 'cover_letter' %}–°–æ–ø—Ä–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ –ø–∏—Å—å–º–æ
                            {% else %}{{ document.type }}{% endif %}
                        </p>
                        <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                            <span class="badge 
                                {% if document.status == 'draft' %}bg-secondary
                                {% elif document.status == 'in_progress' %}bg-warning
                                {% elif document.status == 'completed' %}bg-success
                                {% elif document.status == 'approved' %}bg-info
                                {% elif document.status == 'signed' %}bg-primary
                                {% else %}bg-secondary{% endif %}">
                                {{ document.status }}
                            </span>
                        </p>
                        <p><strong>–ê–≤—Ç–æ—Ä:</strong> {{ document.author.full_name }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ document.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
                        <p><strong>UUID:</strong> {{ document.uuid }}</p>
                        <p><strong>–•—ç—à:</strong> <small>{{ document.original_hash[:20] }}...</small></p>
                    </div>
                </div>

                <!-- –ö–ù–û–ü–ö–ò –î–õ–Ø –ò–°–ü–û–õ–ù–ò–¢–ï–õ–Ø -->
                {% if current_stage and current_stage.role_required == 'executor' and current_stage.action == 'encrypt' %}
                    <div class="alert alert-warning">
                        <h5>–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ!</h5>
                        <p>–≠—Ç–∞–ø {{ current_stage.stage_number }}: {{ current_stage.title }}</p>
                        <form method="POST" action="{{ url_for('process_document', doc_id=document.id) }}">
                            <input type="hidden" name="action" value="encrypt">
                            <div class="mb-3">
                                <label for="comments" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                                <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">–ó–ê–®–ò–§–†–û–í–ê–¢–¨ –î–û–ö–£–ú–ï–ù–¢</button>
                        </form>
                    </div>
                {% endif %}

                <!-- –ö–ù–û–ü–ö–ò –î–õ–Ø –î–†–£–ì–ò–• –î–ï–ô–°–¢–í–ò–ô -->
                {% if current_stage and current_stage.assigned_to == current_user.id %}
                    <div class="alert alert-info">
                        <h5>–¢—Ä–µ–±—É–µ—Ç—Å—è –≤–∞—à–µ –¥–µ–π—Å—Ç–≤–∏–µ:</h5>
                        <form method="POST" action="{{ url_for('process_document', doc_id=document.id) }}">
                            <input type="hidden" name="action" value="{{ current_stage.action }}">
                            <div class="mb-3">
                                <label for="comments" class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
                                <textarea class="form-control" id="comments" name="comments" rows="2"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                {% if current_stage.action == 'review' %}–ü–†–û–í–ï–†–ò–¢–¨
                                {% elif current_stage.action == 'approve' %}–£–¢–í–ï–†–î–ò–¢–¨
                                {% elif current_stage.action == 'register' %}–ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–¢–¨
                                {% elif current_stage.action == 'send' %}–û–¢–ü–†–ê–í–ò–¢–¨
                                {% elif current_stage.action == 'encrypt' %}–ó–ê–®–ò–§–†–û–í–ê–¢–¨
                                {% else %}–í–´–ü–û–õ–ù–ò–¢–¨{% endif %}
                            </button>
                        </form>
                    </div>
                {% endif %}

                <!-- –°–ö–ê–ß–ò–í–ê–ù–ò–ï -->
                <div class="mb-3">
                    <a href="{{ url_for('download_document', doc_id=document.id) }}" class="btn btn-success">
                        üì• –°–∫–∞—á–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
                    </a>
                </div>
            </div>
        </div>

        <!-- –ú–ê–†–®–†–£–¢ –î–û–ö–£–ú–ï–ù–¢–ê -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>–ú–∞—Ä—à—Ä—É—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for stage in route_config %}
                        <div class="timeline-item {% if stage.stage == document.current_stage %}current{% elif stage.stage < document.current_stage %}completed{% endif %}">
                            <div class="timeline-marker">
                                {% if stage.stage == document.current_stage %}üü¢
                                {% elif stage.stage < document.current_stage %}‚úÖ
                                {% else %}‚≠ï{% endif %}
                            </div>
                            <div class="timeline-content">
                                <h6>–≠—Ç–∞–ø {{ stage.stage }}: {{ stage.title }}</h6>
                                <p>
                                    <strong>–†–æ–ª—å:</strong> {{ stage.role }}<br>
                                    <strong>–î–µ–π—Å—Ç–≤–∏–µ:</strong> {{ stage.action }}<br>
                                    <strong>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</strong> {{ stage.assigned_name }}
                                </p>
                                {% if stage.stage == document.current_stage and stage.role == current_user.role %}
                                    <form method="POST" action="{{ url_for('process_document', doc_id=document.id) }}" style="display:inline;">
                                        <input type="hidden" name="action" value="{{ stage.action }}">
                                        <button type="submit" class="btn btn-sm btn-warning">
                                            –í—ã–ø–æ–ª–Ω–∏—Ç—å {{ stage.action }}
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- –≠–¢–ê–ü–´ -->
        <div class="card">
            <div class="card-header">
                <h5>–≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</h5>
            </div>
            <div class="card-body">
                {% for stage in stages %}
                    <div class="mb-3 p-2 border rounded {% if stage.status == 'completed' %}bg-light{% elif stage.stage_number == document.current_stage %}bg-warning{% endif %}">
                        <h6>–≠—Ç–∞–ø {{ stage.stage_number }}: {{ stage.action|title }}</h6>
                        <p>
                            <strong>–†–æ–ª—å:</strong> {{ stage.role_required }}<br>
                            <strong>–°—Ç–∞—Ç—É—Å:</strong> 
                            <span class="badge {% if stage.status == 'completed' %}bg-success{% else %}bg-secondary{% endif %}">
                                {{ stage.status }}
                            </span><br>
                            <strong>–ù–∞–∑–Ω–∞—á–µ–Ω:</strong> {% if stage.assigned_user %}{{ stage.assigned_user.full_name }}{% else %}–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω{% endif %}
                        </p>
                        
                        <!-- –ö–ù–û–ü–ö–ê –î–õ–Ø EXECUTOR –î–ê–ñ–ï –ï–°–õ–ò –ù–ï –ù–ê–ó–ù–ê–ß–ï–ù -->
                        {% if stage.role_required == 'executor' and stage.action == 'encrypt' and stage.status == 'pending' %}
                            {% if current_user.role == 'executor' %}
                                <form method="POST" action="{{ url_for('process_document', doc_id=document.id) }}">
                                    <input type="hidden" name="action" value="encrypt">
                                    <div class="mb-2">
                                        <textarea class="form-control form-control-sm" name="comments" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" rows="2"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-sm btn-primary">–Ø EXECUTOR - –ó–ê–®–ò–§–†–û–í–ê–¢–¨</button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>

        <!-- –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø -->
        <div class="card mt-4">
            <div class="card-header">
                <h5>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if has_permission(current_user.role, 'can_sign_document') %}
                        <a href="{{ url_for('sign_document', doc_id=document.id) }}" class="btn btn-outline-primary">–ü–æ–¥–ø–∏—Å–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</a>
                    {% endif %}
                    
                    <!-- –û–°–û–ë–ê–Ø –ö–ù–û–ü–ö–ê –î–õ–Ø EXECUTOR -->
                    {% if document.type == 'service_note' and document.current_stage == 2 %}
                        {% if current_user.role == 'executor' %}
                            <form method="POST" action="{{ url_for('process_document', doc_id=document.id) }}">
                                <input type="hidden" name="action" value="encrypt">
                                <button type="submit" class="btn btn-warning">üö® EXECUTOR: –ó–ê–®–ò–§–†–û–í–ê–¢–¨ –°–ï–ô–ß–ê–°</button>
                            </form>
                        {% endif %}
                    {% endif %}
                    
                    <a href="{{ url_for('download_document', doc_id=document.id) }}" class="btn btn-success">–°–∫–∞—á–∞—Ç—å</a>
                    <a href="{{ url_for('documents_list') }}" class="btn btn-secondary">–ö —Å–ø–∏—Å–∫—É –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</a>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline {
    position: relative;
    padding-left: 30px;
}
.timeline-item {
    position: relative;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid #eee;
}
.timeline-item.completed {
    opacity: 0.7;
}
.timeline-item.current {
    background-color: #fff3cd;
    padding: 10px;
    border-radius: 5px;
}
.timeline-marker {
    position: absolute;
    left: -30px;
    top: 0;
    font-size: 20px;
}
.timeline-content {
    margin-left: 10px;
}
</style>
{% endblock %}